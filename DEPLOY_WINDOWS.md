## Деплой Schedule AD Blocker на Windows (без Docker)

Этот документ описывает несколько вариантов деплоя бэкенда **Schedule AD Blocker** на Windows‑сервере **без использования Docker**. Во всех примерах предполагается, что:

- код приложения размещен в какой‑то директории, например `C:\apps\schedule-ad-blocker`;
- настроен файл `.env` с корректными параметрами БД, LDAP и JWT;
- установлен **Node.js (LTS)** и **PostgreSQL** (или есть доступ к внешней БД);
- доступ к AD по LDAP работает с сервера, на который производится деплой.

Рекомендуемый общий подход:

1. Подготовить директорию с приложением.
2. Установить зависимости, прогнать миграции Prisma.
3. Собрать приложение (`npm run build`).
4. Запускать `node dist/main.js` как службу/фоновый процесс, автоматически стартующий при загрузке системы.

Ниже — несколько вариантов организации службы.

---

### 1. Вариант с NSSM (Non-Sucking Service Manager) — **рекомендуется**

**Плюсы**:

- простой в настройке;
- удобно управлять перезапуском, логами;
- не требует дополнительного Node‑процесса‑оркестратора.

#### 1.1. Установка NSSM

1. Скачать NSSM с официального сайта (`nssm.cc`) и распаковать, например в `C:\tools\nssm`.
2. Добавить путь к `nssm.exe` в `PATH` или использовать полный путь в командах.

#### 1.2. Подготовка приложения

```powershell
cd C:\apps\schedule-ad-blocker

# Установка зависимостей
npm install

# Применение миграций Prisma (при необходимости)
npx prisma migrate deploy

# Сборка
npm run build
```

Убедитесь, что `.env` лежит в `C:\apps\schedule-ad-blocker\.env`.

#### 1.3. Создание Windows‑службы

```powershell
nssm install ScheduleAdBlocker
```

В открывшемся GUI:

- **Path**: путь к `node.exe`, например `C:\Program Files\nodejs\node.exe`
- **Arguments**: `dist/main.js`
- **Startup directory**: `C:\apps\schedule-ad-blocker`

Рекомендуемые настройки:

- Вкладка **Details**:
  - Display name: `Schedule AD Blocker`
  - Startup type: `Automatic`
- Вкладка **I/O**:
  - Output (stdout): `C:\apps\schedule-ad-blocker\logs\service-out.log`
  - Error (stderr): `C:\apps\schedule-ad-blocker\logs\service-error.log`

Сохранить настройки (ОК), затем запустить службу:

```powershell
nssm start ScheduleAdBlocker
```

Проверить, что приложение отвечает по `http://<server>:3000/graphql`.

---

### 2. Вариант с PM2 как службой Windows

**Плюсы**:

- удобный просмотр логов, автоперезапуск, мониторинг;
- возможность запускать несколько Node‑сервисов.

**Минусы**:

- дополнительный слой (PM2) и отдельный шаг по регистрации его как службы.

#### 2.1. Установка PM2

```powershell
npm install -g pm2
```

#### 2.2. Запуск приложения через PM2

```powershell
cd C:\apps\schedule-ad-blocker

# Установка зависимостей и сборка (если еще не сделаны)
npm install
npx prisma migrate deploy
npm run build

# Старт через PM2
pm2 start dist/main.js --name schedule-ad-blocker
```

Проверить статус:

```powershell
pm2 status
pm2 logs schedule-ad-blocker
```

#### 2.3. Автозапуск PM2 при старте системы

PM2 умеет генерировать скрипты автозапуска, в т.ч. для Windows (через `pm2-windows-startup` или Task Scheduler). Один из рабочих вариантов:

1. Установить `pm2-windows-startup`:

```powershell
npm install -g pm2-windows-startup
pm2-startup install
```

2. Сохранить текущую конфигурацию процессов:

```powershell
pm2 save
```

Теперь при перезагрузке сервера PM2 поднимется и запустит сохраненные процессы.

---

### 3. Вариант с Планировщиком задач (Task Scheduler)

Этот вариант подходит, если не хочется использовать сторонние инструменты (NSSM, PM2).

#### 3.1. Подготовка командного файла

Создайте файл `C:\apps\schedule-ad-blocker\start-service.cmd`:

```cmd
@echo off
cd /d C:\apps\schedule-ad-blocker
call "C:\Program Files\nodejs\node.exe" dist\main.js
```

#### 3.2. Создание задания в Планировщике задач

1. Открыть **Планировщик задач** (Task Scheduler).
2. Создать **новое задание**:
   - **Общие**:
     - Имя: `ScheduleAdBlockerService`
     - Выполнять от имени учетной записи с правом доступа к БД и AD.
     - Включить «Запускать с наивысшими правами».
   - **Триггеры**:
     - При запуске системы.
   - **Действия**:
     - Запуск программы:
       - Программа/скрипт: `C:\apps\schedule-ad-blocker\start-service.cmd`
   - **Условия/Параметры**:
     - При необходимости включить авто‑перезапуск при ошибках.

3. Сохранить задание и протестировать запуск вручную.

---

### Общее для всех вариантов

#### Логи

- Приложение пишет логи через **winston** в директорию `logs` (в том числе отдельные логи для cron).
- На уровне службы/оркестратора (NSSM/PM2/Task Scheduler) имеет смысл также направлять stdout/stderr в отдельные файлы для диагностики.

#### Обновление версии приложения

Типичный процесс обновления:

1. Остановить службу/процесс (NSSM/PM2/задание).
2. Обновить код (pull из Git/копирование артефактов).
3. Выполнить:

```powershell
cd C:\apps\schedule-ad-blocker
npm install        # при изменении зависимостей
npx prisma migrate deploy
npm run build
```

4. Запустить службу/процесс снова.

#### Безопасность

- Следить за обновлением Node.js и зависимостей (особенно `ldap*`, `jsonwebtoken`, `passport*`).
- Размещать `.env` и логи в директориях с ограниченным доступом.
- В продакшене обязательно использовать HTTPS‑терминатор (IIS/Reverse Proxy/Nginx/Apache) перед Node‑приложением, если оно доступно извне.

---

### Рекомендации по выбору варианта

- **NSSM** — оптимальный выбор для простого, надежного сервиса на одном сервере Windows.
- **PM2** — хорошо подходит, если на сервере будет несколько Node‑приложений и нужен удобный мониторинг.
- **Task Scheduler** — минимальный вариант без сторонних утилит, если политика компании не позволяет ставить дополнительный софт.


